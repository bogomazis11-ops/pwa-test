<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MARCHE - Accès sécurisé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1976d2">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .card {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 12px;
      background: white;
      margin-top: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .locked {
      text-align: center;
      padding: 40px;
      font-size: 20px;
      color: #444;
    }
    button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <h1>MARCHE — Accès personnel</h1>
  <p>Accès sécurisé réservé aux utilisateurs identifiés via QR-code.</p>

  <div id="locked" class="locked" style="display:none">
    ❌ <br> Accès refusé.<br><br>
    Ce lien ne contient pas d'identifiant valide.<br>
    Veuillez scanner votre QR-code personnel.
  </div>

  <div id="card" class="card" style="display:none">
    <h3>Vos informations</h3>

    <p><b>Prénom:</b> <span id="prenom"></span></p>
    <p><b>Nom:</b> <span id="nom"></span></p>
    <p><b>Licence:</b> <span id="licence"></span></p>
    <p><b>Statut:</b> <span id="actif"></span></p>
  </div>

  <button id="installBtn" hidden>Installer l'application</button>

<script>
  // PARAMÈTRE D'IDENTIFICATION VIA QR
  const params = new URLSearchParams(window.location.search);
  const userId = params.get("user");

  // === MÉCANISME D'AUTHENTIFICATION AUTOMATIQUE (PWA INSTALLÉE) ===

  // 1. Si userId existe (entrée via QR), on l'enregistre
  if (userId) {
    localStorage.setItem("loggedUser", userId);
  }

  // 2. Si l'application est lancée SANS ?user= (cas d'une PWA installée)
  if (!userId) {
    const storedUser = localStorage.getItem("loggedUser");

    if (storedUser) {
      // Redirection automatique vers l'utilisateur enregistré
      window.location.replace(window.location.pathname + "?user=" + storedUser);
      throw new Error("Redirection vers utilisateur sauvegardé");
    }
  }

  // APRÈS CE POINT, userId DOIT ÊTRE VALIDÉ
  const finalUser = userId || localStorage.getItem("loggedUser");

  const locked = document.getElementById("locked");
  const card = document.getElementById("card");

  if (!finalUser) {

    // Récupération utilisateur sauvegardé (PWA installée)
    const storedUser = localStorage.getItem("loggedUser");
    if (storedUser) {
      window.location.replace("index.html?user=" + storedUser);
      return;
    }
    locked.style.display = "block";
  } else {
    // CHARGEMENT DES DONNÉES UTILISATEUR
    fetch("data.json")
      .then(r => r.json())
      .then(data => {
        if (!data[finalUser]) {
          locked.style.display = "block";
          return;
        }

        const u = data[finalUser];
        document.getElementById("prenom").textContent = u.prenom;
        document.getElementById("nom").textContent = u.nom;
        document.getElementById("licence").textContent = u.licence;
        document.getElementById("actif").textContent = u.actif ? "Actif" : "Non actif";

        card.style.display = "block";
      })
      .catch(err => {
        console.error("Erreur chargement JSON", err);
        locked.innerHTML = "⚠ Impossible de charger les données.";
        locked.style.display = "block";
      });
  }

  // SERVICE WORKER
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('SW installé'))
      .catch(err => console.error('SW erreur:', err));
  }

  // INSTALLATION PWA
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.hidden = false;
  });

  installBtn.addEventListener('click', async () => {
    installBtn.hidden = true;
    if (!deferredPrompt) return;

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log("Install:", outcome);
    deferredPrompt = null;
  });
</script>

</body>
</html>
